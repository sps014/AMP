<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8'>
    <meta http-equiv='X-UA-Compatible' content='IE=edge'>
    <title>Page Title</title>
    <meta name='viewport' content='width=device-width, initial-scale=1'>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/0.9.0/p5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/0.9.0/addons/p5.dom.min.js"></script>
    <script src="https://unpkg.com/ml5@0.4.3/dist/ml5.min.js"></script>
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <link rel="stylesheet" href="https://code.getmdl.io/1.3.0/material.indigo-pink.min.css">
    <script defer src="https://code.getmdl.io/1.3.0/material.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.5.0/firebase-app.js"></script>
<!-- TODO: Add SDKs for Firebase products that you want to use
     https://firebase.google.com/docs/web/setup#available-libraries -->
   <script src="https://www.gstatic.com/firebasejs/7.5.0/firebase-analytics.js"></script>
   <script src="https://www.gstatic.com/firebasejs/7.5.0/firebase-database.js"></script>

    <script src="CamFetcher.js"></script>
    <script src="CNN.js"></script>

</head>
<body>


        <div class = "mdl-layout mdl-js-layout mdl-layout--fixed-header mdl-layout--fixed-tabs">
                <header class = "mdl-layout__header" style="background-color:crimson;">
                   <!-- Top row, always visible -->
                   <div class = "mdl-layout__header-row">
                      <!-- Title -->
                      <span class = "mdl-layout-title">AMP</span>          
                   </div>
                
                   <!-- Tabs -->
                   <div class = "mdl-layout__tab-bar mdl-js-ripple-effect" style="background-color: crimson;">
                      <a href = "#scroll-tab-1" class = "mdl-layout__tab is-active">Main</a>
                      <a href = "#scroll-tab-3" class = "mdl-layout__tab">Settings</a>     
                   </div>
                </header>
                
                <div class = "mdl-layout__drawer">
                   <span class = "mdl-layout-title">Contact Us</span>
                   <nav class = "mdl-navigation">
                      <a class = "mdl-navigation__link" href = "">Report Issue</a>    
                   </nav>
                </div>
                
                <main class = "mdl-layout__content">
                   <section class = "mdl-layout__tab-panel is-active" id = "scroll-tab-1">
                      <div class = "page-content">


                            <div id="vidContainer" style="position: absolute; top: 10px;left:10px">
                                </div>

                                <div class="demo-card-event mdl-card mdl-shadow--2dp" 
                                style='position: absolute;left: 51%;top:10px;width: 48%;height: 95%;
                                background-color: gold;'>
                                 <div class="mdl-card__title mdl-card--expand">


                                    <div
                                     style="position: absolute;top: 60px;left: 0px;
                                      bottom: 10%px;background: rgb(187, 229, 235);width: 100%;height:78.3%;">
                                      <img src="./Assets/Images/banner.png" height="100%" width="100%"/>
                                    </div>

                                    <b>
                                   <h4 style="position: absolute;top:-10px;color: dodgerblue;font-weight: bold;">
                                     Delhi Metro Tokenizer
                                   </h4></b>
                                   <h5 style="font-weight: bold;position: absolute;color: dodgerblue;
                                   right: 20px; top:-5px" id="tokenId">******1223234</h5>
                                    <p style="color: crimson;
                                     font-size: 32px;position: absolute;top: 25%; 
                                     align-self: auto;left: 40px; font-weight: normal;
                                     " id="fromTo">From ➡ To</p>
                                     <p style="color: black;
                                     font-size: 22px;position: absolute;top: 40%;left: 40px; 
                                    font-weight: bold;" id="nameM">Name</p>
                                    <p style="color: black;
                                    font-size: 22px;position: absolute;top: 40%;right: 40px; 
                                   font-weight: bold;" id="dateTime">Date & Time</p>
                                   <p style="color: black;
                                   font-size: 22px;position: absolute;top: 55%;right: 40%;text-align: center; 
                                  font-weight: bold;">Exit Gate Number</p>
                                  <p style="color: black;
                                  font-size: 22px;position: absolute;top: 60%;right: 50%;text-align: center; 
                                 font-weight: bold;" id="gateID">1</p>
                                 </div>
                                 <div class="mdl-card__actions mdl-card--border">
                                   <a class="mdl-button mdl-button--colored mdl-js-button mdl-js-ripple-effect" 
                                    style="color: green;font-weight: bold; font-size: 20px;top: 10px;"
                                    >
                                     Total Amount:
                                   </a>
                                   <a class="mdl-button mdl-button--colored mdl-js-button mdl-js-ripple-effect" 
                                    style="color: green;font-weight: bold; font-size: 20px;top: 91%; right: 10px;position: absolute;"
                                    id="cost">
                                     $ 0.0
                                   </a>
                                   <div class="mdl-layout-spacer"></div>
                                   <i class="material-icons" style="color: green;top: -10px;right:10px;position:static;"></i>
                                 </div>
                               </div>


                      </div>
                   </section>


                   <section class = "mdl-layout__tab-panel" id = "scroll-tab-3">
                      <div class = "page-content">Tab 3 Contents</div>
                   </section>
                </main>
             </div>
   

    <script type="text/javascript">
         
    var firebaseConfig = {
    apiKey: "AIzaSyBKOpv59iwlHXJFijXoaHfouBKLQt_QHJA",
    authDomain: "sonic-quiz-8af26.firebaseapp.com",
    databaseURL: "https://sonic-quiz-8af26.firebaseio.com",
    projectId: "sonic-quiz-8af26",
    storageBucket: "sonic-quiz-8af26.appspot.com",
    messagingSenderId: "255729415959",
    appId: "1:255729415959:web:e9341b6e44ac0d63302952",
    measurementId: "G-4169G2B6SV"
  };
  firebase.initializeApp(firebaseConfig);
  var ref = firebase.database().ref();


        //const URL='https://teachablemachine.withgoogle.com/models/C4-gcUP0/';
        const URL='https://teachablemachine.withgoogle.com/models/wlGPorLq/';

        const fet=new CamFetcher(this.innerWidth/2-20,this.innerHeight-140,'vidContainer',getImageFrame);

        const cnn=new CNN(URL);
      
        function getImageFrame(video)
        {
            cnn.Classify(video,getCnnResult);
        }
      
        function getCnnResult(error,results)
        {
              if (error)
              {
                  console.error(error);
                  return;
              }
      
      
          const label = results[0].label;

          getData(label);
      
        }

        function getData(label)
        {
         ref.child("names").child(label).once("value",
          function(snapshot)
          {
            loadData(snapshot.val());
            BalDeduction(snapshot.val(),label);
          }, 
          function (error)
           {
            console.log("Error: " + error.code);
         });
        }
        function loadData(obj)
        {
           document.getElementById("tokenId").innerHTML=obj.uid;
           document.getElementById("nameM").innerHTML=obj.name;
           document.getElementById("dateTime").innerHTML=    new Date().toLocaleString();
           document.getElementById("fromTo").innerHTML=obj.instn+" ➡ "+obj.outstn;
           document.getElementById("cost").innerHTML=obj.cost;
           document.getElementById("gateID").innerHTML=obj.gateID;


        }

        function getInt(str)
        {
           return parseInt(str);
        }
        let startTime=0;
        function deduct(obj,label)
        {
           if(parseInt(obj.avalBal)>parseInt(obj.cost) && new Date().getTime()-startTime>=10000)
           {
            let labelz=ref.child("names").child(label);
            labelz.child("avalBal").set((parseInt(obj.avalBal)-parseInt(obj.cost)).toString());
            labelz.child("lastOut").set((new Date().getTime()).toString());
            labelz.child("lastIn").set("");
            console.log('')
            startTime=new Date().getTime();

           }
           else
           {
              //error no balance 
           }
        }
        function BalDeduction(obj,label)
        {
           if(obj.name=="")
           {
              return;
           }
           if(obj.instn=="")
           {
              let curTime=new Date().getTime();
  
              let lastOut=getInt(obj.lastOut);
              if(curTime-lastOut>=1000*60)
              {
               console.log('you are not allowed since you havent verified from entry gate meet autorities.');
              }

           }
           else 
           {
              let inTime=getInt(obj.lastIn);
              let outTime=getInt(new Date().getTime());
              if(obj.lastIn=="")
              {
                 console.log("meet autorities");
              }

              else if((outTime-inTime)>=1*20*1000)
              {
                 //deduct balance
                 deduct(obj,label);
              }
              else
              {
                 console.log('go man'+":"+outTime-inTime);
              }
           }
           



        }



      </script>
      
</body>
</html>